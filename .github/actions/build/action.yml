name: Build and cache Docker dev image
description: Build Docker dev image and cache it on GCR

inputs:
  tag:
    description: The docker image tag
    required: false
    default: dev
  hash:
    description: The docker image hash
    required: true
  extra-containers:
    description: List of container names to up
    required: false
    default: 'false'
  keys:
    description: Set to 'true' to generate private & public ssl keys
    required: false
    default: 'false'
  cache-warmup:
    description: Set to 'true' to clear and warmup cache
    required: false
    default: 'false'

runs:
  using: composite
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      uses: docker/bake-action@v3
      with:
          load: true
          files: |
              docker-compose.yml
              docker-compose.ci.yml
          set: |
              *.args.BUILD_DEV=1
              *.cache-from=type=gha,scope=${{github.ref}}
              *.cache-from=type=gha,scope=refs/heads/main
              *.cache-to=type=gha,scope=${{github.ref}},mode=max

    - name: Start app container
      shell: bash
      env:
        TAG: ${{ inputs.tag }}
        HASH: ${{ inputs.hash }}
        CONTAINERS: app
      run: make up-no-deps

    - name: Install composer dependencies
      shell: bash
      run: make vendor

    - name: Create private & public key
      if: inputs.keys == 'true'
      shell: bash
      run: make keys perm

    - name: Build cache
      if: inputs.cache-warmup == 'true'
      shell: bash
      run: |-
        make tfp-cc

    - name: Start extra containers
      if: inputs.extra-containers != 'false'
      shell: bash
      env:
        CONTAINERS: ${{ inputs.extra-containers }}
      run: make up-no-deps

version: "3.9"

# You can connect other docker app like api.en-marche.fr by setting up an external network.
# First, create that network by running `docker network create enmarche`.
# Then you can uncomment this section and specify networks required by each
# container by also uncommenting services.app.networks section for example.
# If you want to share the RabbitMQ container, make sure all your app are configured
# with the right connection config.

networks:
  proxy:
    name: proxy

services:
  nginx-proxy:
      image: jwilder/nginx-proxy
      networks:
          - default
          - proxy
      ports:
          - "80:80"
      volumes:
          - /var/run/docker.sock:/tmp/docker.sock:ro

  app:
    networks:
      default:
        aliases:
          - test.enmarche.code
          - enmarche.code
      proxy:
        aliases:
          - test.enmarche.code
          - enmarche.code
    volumes:
      - "~/.composer:/home/enmarche/.composer"
      - "~/.cache:/home/enmarche/.cache"
      - "./vendor:/app/vendor:cached"
      - "./:/app:rw,cached"
      - "/app/var"
    environment:
      - BLACKFIRE_CLIENT_ID=4a9647b7-c110-4ab0-b3ca-a12edc0ffe9b
      - BLACKFIRE_CLIENT_TOKEN=cbf8a4e952f2ef9ab4ffe031c5a67ddfcc281b66b612555161cc27bc1cf2f41f
      - VIRTUAL_HOST=enmarche.code,test.enmarche.code,m.enmarche.code,login.coalitions.code,login.jemengage.code,procuration.avecvous.code,assesseur.avecvous.code
      - VIRTUAL_PORT=80

  rabbitmq:
    networks:
      default: ~
      proxy:
        aliases:
          - rabbitmq-enmarche
    environment:
      - VIRTUAL_HOST=rabbitmq.enmarche.code
      - VIRTUAL_PORT=15672
    ports:
      - '5672:5672'

  db:
    ports:
      - "3306:3306"

  #    db:
  #        ports:
  #            - "5432:5432"

  #    blackfire:
  #        image: blackfire/blackfire:2
  #        environment:
  ##            BLACKFIRE_LOG_LEVEL: 4
  #            BLACKFIRE_SERVER_ID: 65374612-ef88-4500-8b3d-1a014d972894
  #            BLACKFIRE_SERVER_TOKEN: 489c23c26e3755f19bce9a0c929c6a3e4adb4f9459665295712cd0010b255c2d
  ##            BLACKFIRE_CLIENT_ID: 4a9647b7-c110-4ab0-b3ca-a12edc0ffe9b
  ##            BLACKFIRE_CLIENT_TOKEN: cbf8a4e952f2ef9ab4ffe031c5a67ddfcc281b66b612555161cc27bc1cf2f41f

  redis:
    ports:
      - 6379:6379

  selenium:
    networks:
      - default
      - proxy
    ports:
      - 5900:5900

#volumes:
#    nfsmount:
#        driver: local
#        driver_opts:
#            type: nfs
#            o: addr=host.docker.internal,rw,nolock,hard,nointr,nfsvers=3
#            device: ":${PWD}"
